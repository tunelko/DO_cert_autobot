name: DO Cert Autobot CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint requests dnspython pyOpenSSL

      - name: Lint Python code with flake8
        run: |
          flake8 certbot_auto.py --max-line-length=120 --ignore=E501,W503

      - name: Lint shell scripts with shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          format: tty

      - name: Validate Python syntax
        run: |
          python -m py_compile certbot_auto.py

      - name: Check shell script syntax
        run: |
          bash -n auth-hook.sh
          bash -n cleanup-hook.sh

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit security scan
        id: bandit
        run: |
          echo "## Bandit Security Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          bandit -r . -x ./.git --severity-level medium -f json -o bandit.json || true
          bandit -r . -x ./.git --severity-level medium -f txt | tee bandit_output.txt || true
          cat bandit_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Security gate: fail if 1+ critical, high or medium
          CRITICAL=$(cat bandit.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(sum(1 for r in d.get('results',[]) if r['issue_severity']=='CRITICAL'))")
          HIGH=$(cat bandit.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(sum(1 for r in d.get('results',[]) if r['issue_severity']=='HIGH'))")
          MEDIUM=$(cat bandit.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(sum(1 for r in d.get('results',[]) if r['issue_severity']=='MEDIUM'))")
          echo "Critical: $CRITICAL, High: $HIGH, Medium: $MEDIUM"
          if [ "$CRITICAL" -ge 1 ] || [ "$HIGH" -ge 1 ] || [ "$MEDIUM" -ge 1 ]; then
            echo "Security gate FAILED: Critical=$CRITICAL, High=$HIGH, Medium=$MEDIUM"
            exit 1
          fi
          echo "Security gate PASSED"

      - name: Run Trivy vulnerability scanner
        id: trivy
        run: |
          echo "## Trivy Vulnerability Scan" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker run --rm -v $(pwd):/src aquasec/trivy fs /src --severity CRITICAL,HIGH,MEDIUM -f json -o /src/trivy.json 2>&1 || true
          docker run --rm -v $(pwd):/src aquasec/trivy fs /src --severity CRITICAL,HIGH,MEDIUM 2>&1 | tee trivy_output.txt || true
          cat trivy_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Security gate for Trivy
          if [ -f trivy.json ]; then
            TRIVY_CRITICAL=$(cat trivy.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(sum(len(r.get('Vulnerabilities',[])) for r in d.get('Results',[]) if r.get('Vulnerabilities') for v in r['Vulnerabilities'] if v.get('Severity')=='CRITICAL'))" 2>/dev/null || echo 0)
            TRIVY_HIGH=$(cat trivy.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(sum(1 for r in d.get('Results',[]) if r.get('Vulnerabilities') for v in r['Vulnerabilities'] if v.get('Severity')=='HIGH'))" 2>/dev/null || echo 0)
            echo "Trivy - Critical: $TRIVY_CRITICAL, High: $TRIVY_HIGH"
            if [ "$TRIVY_CRITICAL" -ge 1 ] || [ "$TRIVY_HIGH" -ge 1 ]; then
              echo "Trivy security gate FAILED"
              exit 1
            fi
          fi
          echo "Trivy security gate PASSED"

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          if grep -q "No issues identified" bandit_output.txt; then
            echo "| Bandit (Python SAST) | PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Bandit (Python SAST) | CHECK |" >> $GITHUB_STEP_SUMMARY
          fi
          if grep -q "Total: 0" trivy_output.txt || grep -q "No issues detected" trivy_output.txt; then
            echo "| Trivy (Vulnerabilities) | PASS |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Trivy (Vulnerabilities) | CHECK |" >> $GITHUB_STEP_SUMMARY
          fi
